{
  "hash": "2482dff1181b443d74c7332fc0d4343f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Aula 3 - Transformação de dados\"\nauthor: Danilo Oliveira Ramos\nformat: html\n---\n\n\n\n\n# Transformação de dados\n\nVamos analisar o efeito de diferentes tipos de inseticidas (`spray`) sobre a contagem de insetos (`count`) usando métodos estatísticos adequados. Para isso vamos usar um dataset do R. O foco é verificar **diferenças significativas entre grupos**, garantindo que as **premissas dos testes paramétricos** sejam atendidas. Caso não sejam, parte-se para alternativas **não paramétricas** ou modelos mais adequados (GLM).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(datasets)\n\ninsetos <- InsectSprays\n\ninsetos |> \n  ggplot(aes(spray, count))+\n  geom_boxplot()+\n  geom_jitter(width = 0.1)\n```\n\n::: {.cell-output-display}\n![](aula3_2_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\n\n\n## Teste de homogeneidade de variâncias\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbartlett.test(count ~ spray, data = insetos)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tBartlett test of homogeneity of variances\n\ndata:  count by spray\nBartlett's K-squared = 25.96, df = 5, p-value = 9.085e-05\n```\n\n\n:::\n\n```{.r .cell-code}\n# A normalidade pode ser um pouco violada, mas a homogeneidade de variância é crucial para ANOVA\n```\n:::\n\n\n\n\nSe **não houver homogeneidade**, o teste F do ANOVA **não é confiável**\n\n# Transformação Raiz quadrada (sqrt)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm2 <- lm(sqrt(count) ~ spray, data = insetos)\n\n\nhist(residuals(m2))\n```\n\n::: {.cell-output-display}\n![](aula3_2_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code}\nshapiro.test(residuals(m2)) #shapiro é mais rigoroso,especialmente com n pequeno\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tShapiro-Wilk normality test\n\ndata:  residuals(m2)\nW = 0.98721, p-value = 0.6814\n```\n\n\n:::\n\n```{.r .cell-code}\nqqnorm(residuals(m2)); qqline(residuals(m2))\n```\n\n::: {.cell-output-display}\n![](aula3_2_files/figure-html/unnamed-chunk-3-2.png){width=672}\n:::\n:::\n\n\n\n\nAplicou-se a transformação **raiz quadrada** (`sqrt`) na variável `count` para melhorar a homogeneidade das variâncias e a normalidade dos resíduos.\n\nTeste de **Shapiro-Wilk** e gráficos Q-Q para avaliar se os resíduos seguem distribuição normal (pré-requisito da ANOVA\n\n## Modelo linear com resposta transformada (ANOVA paramétrico)\n\nANOVA é aplicada sobre os dados transformados, assumindo que os resíduos agora estão mais adequados.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## aternativa 1 - transforma a resposta em raiz quadrada (sqrt)\nm3 <- lm(sqrt(count) ~ spray, data = insetos)\nhist(residuals(m3))\n```\n\n::: {.cell-output-display}\n![](aula3_2_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\nshapiro.test(residuals(m3))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tShapiro-Wilk normality test\n\ndata:  residuals(m3)\nW = 0.98721, p-value = 0.6814\n```\n\n\n:::\n\n```{.r .cell-code}\nqqnorm(residuals(m3))\nqqline(residuals(m3))\n```\n\n::: {.cell-output-display}\n![](aula3_2_files/figure-html/unnamed-chunk-4-2.png){width=672}\n:::\n\n```{.r .cell-code}\nanova(m3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Variance Table\n\nResponse: sqrt(count)\n          Df Sum Sq Mean Sq F value    Pr(>F)    \nspray      5 88.438 17.6876  44.799 < 2.2e-16 ***\nResiduals 66 26.058  0.3948                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n#### Comparação das médias:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(emmeans)\nlibrary(multcomp)\nm33 <- emmeans(m3, ~ spray, type = \"response\")\ncld(m33)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n spray response    SE df lower.CL upper.CL .group\n C         1.55 0.452 66    0.779     2.58  1    \n E         3.27 0.656 66    2.095     4.72  12   \n D         4.68 0.785 66    3.248     6.38   2   \n A        14.14 1.360 66   11.550    17.00    3  \n B        15.03 1.410 66   12.352    17.97    3  \n F        16.15 1.460 66   13.370    19.19    3  \n\nConfidence level used: 0.95 \nIntervals are back-transformed from the sqrt scale \nNote: contrasts are still on the sqrt scale. Consider using\n      regrid() if you want contrasts of back-transformed estimates. \nP value adjustment: tukey method for comparing a family of 6 estimates \nsignificance level used: alpha = 0.05 \nNOTE: If two or more means share the same grouping symbol,\n      then we cannot show them to be different.\n      But we also did not show them to be the same. \n```\n\n\n:::\n\n```{.r .cell-code}\nplot(m33)\n```\n\n::: {.cell-output-display}\n![](aula3_2_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\nUsa `emmeans` para obter **médias ajustadas** dos grupos e `cld()` para letras indicando **diferenças significativas** (grupos com letras diferentes são significativamente diferentes\n\n# Alternativa não paramétrica – Kruskal-Wallis\n\nSe nem transformação salvar os pressupostos, usamos o **teste de Kruskal-Wallis**, que é a versão **não paramétrica da ANOVA**\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## alternativa 2 - teste não paramétrico\nlibrary(agricolae)\nlibrary(rstatix)\nkruskal.test(count ~ spray, data = insetos)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tKruskal-Wallis rank sum test\n\ndata:  count by spray\nKruskal-Wallis chi-squared = 54.691, df = 5, p-value = 1.511e-10\n```\n\n\n:::\n\n```{.r .cell-code}\nkruskal_test(insetos, count ~ spray)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 6\n  .y.       n statistic    df        p method        \n* <chr> <int>     <dbl> <int>    <dbl> <chr>         \n1 count    72      54.7     5 1.51e-10 Kruskal-Wallis\n```\n\n\n:::\n\n```{.r .cell-code}\nkruskal(insetos$count, insetos$spray, group = TRUE, console = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nStudy: insetos$count ~ insetos$spray\nKruskal-Wallis test's\nTies or no Ties\n\nCritical Value: 54.69134\nDegrees of freedom: 5\nPvalue Chisq  : 1.510845e-10 \n\ninsetos$spray,  means of the ranks\n\n  insetos.count  r\nA      52.16667 12\nB      54.83333 12\nC      11.45833 12\nD      25.58333 12\nE      19.33333 12\nF      55.62500 12\n\nPost Hoc Analysis\n\nt-Student: 1.996564\nAlpha    : 0.05\nMinimum Significant Difference: 8.462804 \n\nTreatments with the same letter are not significantly different.\n\n  insetos$count groups\nF      55.62500      a\nB      54.83333      a\nA      52.16667      a\nD      25.58333      b\nE      19.33333     bc\nC      11.45833      c\n```\n\n\n:::\n\n```{.r .cell-code}\n#Shapirowilk verifica a normalidade dos dados, o teste de homogeneidade de variancias (levene e barlett)\n```\n:::\n\n\n\n\n-    `kruskal()` do pacote **agricolae** já mostra quais grupos são diferentes, estilo letras post hoc.\n\n# Análise de resíduos\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Aula 23/04\nlibrary(DHARMa)\nm2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = sqrt(count) ~ spray, data = insetos)\n\nCoefficients:\n(Intercept)       sprayB       sprayC       sprayD       sprayE       sprayF  \n     3.7607       0.1160      -2.5158      -1.5963      -1.9512       0.2579  \n```\n\n\n:::\n\n```{.r .cell-code}\nplot(simulateResiduals(m3))\n```\n\n::: {.cell-output-display}\n![](aula3_2_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#adicionei o sqrt no m2= fiz a raiz quadrada - m2 <- lm(sqrt(count) ~ spray, data = insetos) para que melhore a homogeneidade das variancias\n\nlibrary(emmeans)\n#em caso que não conseque fazer transformações que deixem os dados normais deve-se utilizar os testes não paramétricos\n```\n:::\n\n\n\n\nSimula resíduos com o pacote **DHARMa**, que dá uma avaliação mais confiável da qualidade do ajuste do modelo, principalmente útil para GLM e dados de contagem.\n\n# Alternativa paramétrica com GLM Poisson\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm4 <- glm(count ~ spray, data = insetos, family = poisson())\n```\n:::\n\n\n\n\nComo `count` é uma variável de contagem, ajusta-se um **modelo linear generalizado (GLM)** com distribuição de Poisson, que **dispensa a normalidade dos resíduos**.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(m4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table\n\nModel: poisson, link: log\n\nResponse: count\n\nTerms added sequentially (first to last)\n\n      Df Deviance Resid. Df Resid. Dev  Pr(>Chi)    \nNULL                     71     409.04              \nspray  5   310.71        66      98.33 < 2.2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(car)\nlibrary(multcomp)\nAnova(m4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table (Type II tests)\n\nResponse: count\n      LR Chisq Df Pr(>Chisq)    \nspray   310.71  5  < 2.2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\nplot(simulateResiduals(m4))\n```\n\n::: {.cell-output-display}\n![](aula3_2_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n\n```{.r .cell-code}\nmedias_m4 <- emmeans(m4, ~ spray, type = \"response\")\ncld(medias_m4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n spray  rate    SE  df asymp.LCL asymp.UCL .group\n C      2.08 0.417 Inf      1.41      3.08  1    \n E      3.50 0.540 Inf      2.59      4.74  12   \n D      4.92 0.640 Inf      3.81      6.35   2   \n A     14.50 1.100 Inf     12.50     16.82    3  \n B     15.33 1.130 Inf     13.27     17.72    3  \n F     16.67 1.180 Inf     14.51     19.14    3  \n\nConfidence level used: 0.95 \nIntervals are back-transformed from the log scale \nP value adjustment: tukey method for comparing a family of 6 estimates \nTests are performed on the log scale \nsignificance level used: alpha = 0.05 \nNOTE: If two or more means share the same grouping symbol,\n      then we cannot show them to be different.\n      But we also did not show them to be the same. \n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(performance)\n\nm2 <- lm(count ~ spray, data = insetos)\nhist(residuals(m2))\n```\n\n::: {.cell-output-display}\n![](aula3_2_files/figure-html/unnamed-chunk-9-2.png){width=672}\n:::\n\n```{.r .cell-code}\nshapiro.test(residuals(m2))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tShapiro-Wilk normality test\n\ndata:  residuals(m2)\nW = 0.96006, p-value = 0.02226\n```\n\n\n:::\n\n```{.r .cell-code}\nqqnorm(residuals(m2))\nqqline(residuals(m2))\n```\n\n::: {.cell-output-display}\n![](aula3_2_files/figure-html/unnamed-chunk-9-3.png){width=672}\n:::\n:::\n\n\n\n\nANOVA no contexto GLM (`car::Anova`) + diagnóstico de resíduos + comparação entre grupos com `emmeans`.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncheck_model(m2)\n```\n\n::: {.cell-output-display}\n![](aula3_2_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\n`performance::check_model()` fornece diagnóstico visual e numérico do modelo: normalidade, homogeneidade, outliers, colinearidade etc.\n\nO conjunto de dados `InsectSprays` foi analisado para comparar a eficácia de diferentes inseticidas com base na contagem de insetos. Inicialmente, foram avaliadas as suposições da ANOVA, revelando ausência de homogeneidade de variâncias (teste de Bartlett) e indícios de não normalidade nos resíduos (Shapiro-Wilk e Q-Q plot). Para contornar essas limitações, aplicou-se uma transformação raiz quadrada na variável resposta, permitindo o uso de ANOVA com comparação de médias por `emmeans`. Como alternativa, utilizou-se o teste não paramétrico de Kruskal-Wallis, mais robusto frente à violação dos pressupostos, e também um modelo GLM com distribuição de Poisson, mais apropriado para dados de contagem. Os diagnósticos dos modelos (via `DHARMa` e `check_model`) confirmaram a adequação do ajuste, permitindo concluir que houve diferenças estatísticas significativas entre os tipos de spray utilizados.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}